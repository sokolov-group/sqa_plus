def compute_M2_ip(mr_adc, rdm_ca_so, rdm_ccaa_so, rdm_cccaaa_so, rdm_ccccaaaa_so, t1_ce, t1_caea, t1_ca, t1_caaa, t1_ae, t1_aaea):

    e_core_so, e_extern_so = mr_adc.compute_so_generalized_fock()
    e_cas_roots = mr_adc.e_cas_roots

    nroots = mr_adc.nroots
    ni_cas = mr_adc.nion_cas
    ni_so = mr_adc.ni_so
    ncore_so = mr_adc.ncore_so
    ncas_so = mr_adc.ncas_so
    nextern_so = mr_adc.nextern_so
    nocc_so = mr_adc.nocc_so

    dim = ni_cas + ni_so

    sI = mr_adc.sI
    fI = mr_adc.fI
    si = mr_adc.si
    fi = mr_adc.fi

    # Integrals
    h_ca_so = mr_adc.h1e_so[:ncore_so,ncore_so:nocc_so]
    h_ae_so = mr_adc.h1e_so[ncore_so:nocc_so,nocc_so:]
    h_aa_so = mr_adc.h1e_so[ncore_so:nocc_so,ncore_so:nocc_so]
    v_aaaa_so = mr_adc.v2e_so.aaaa
    v_aaea_so = mr_adc.v2e_so.aaea
    v_caaa_so = mr_adc.v2e_so.caaa
    v_caea_so = mr_adc.v2e_so.caea
    v_ceec_so = mr_adc.v2e_so.ceec

    v_acac_so = -mr_adc.v2e_so.caac.transpose(1,0,2,3)
    v_caca_so = -mr_adc.v2e_so.caac.transpose(0,1,3,2)
    v_acca_so = mr_adc.v2e_so.caac.transpose(1,0,3,2)

    v_ccca_so = mr_adc.v2e_so.ccca
    v_caac_so = mr_adc.v2e_so.caac
    v_aeea_so = mr_adc.v2e_so.aeea
    v_acec_so = mr_adc.v2e_so.acec
    v_ceae_so = mr_adc.v2e_so.ceae
    v_ceaa_so = mr_adc.v2e_so.ceaa

    t1_aaca = t1_caaa.transpose(2,3,0,1)

    M = np.zeros((dim, dim))

    # I - J
    if ncore_so > 0:
        print "Computing M(I - J)..."
        sys.stdout.flush()

        M[sI:fI, sI:fI] = np.einsum('ix, ix->IJ', h_ca_so, t1_ca,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('ia, ia->IJ', h_ce_so, t1_ce,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyij, xyij->IJ', t1_aacc, v_aacc_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyij, ijxy->IJ', t1_aacc, v_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xi, xjij->IJ', t1_ac, v_accc_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ix, ijxj->IJ', t1_ca, v_ccac_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ia, ijaj->IJ', t1_ce, v_ccec_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('axij, axij->IJ', t1_eacc, v_eacc_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('axij, ijax->IJ', t1_eacc, v_ccea_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ai, ajij->IJ', t1_ec, v_eccc_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('abij, abij->IJ', t1_eecc, v_eecc_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('abij, ijab->IJ', t1_eecc, v_ccee_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('i, ix, ix->IJ', e_core_so, t1_ca, t1_ca,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('i, ia, ia->IJ', e_core_so, t1_ce, t1_ce,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, xyij, xyij->IJ', e_core_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('i, xaij, xaij->IJ', e_core_so, t1_aecc, t1_aecc,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, abij, abij->IJ', e_core_so, t1_eecc, t1_eecc,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('a, axij, axij->IJ', e_extern_so, t1_eacc, t1_eacc,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('a, ai, ai->IJ', e_extern_so, t1_ec, t1_ec,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('a, abij, abij->IJ', e_extern_so, t1_eecc, t1_eecc,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, xzij, yzij->IJ', h_aa_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('xy, xi, yi->IJ', h_aa_so, t1_ac, t1_ac,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, xaij, yaij->IJ', h_aa_so, t1_aecc, t1_aecc,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, xyij, zwij->IJ', v_aaaa_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, xzjk, yzjk->IJ', v_caca_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('ixiy, xj, yj->IJ', v_caca_so, t1_ac, t1_ac,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, xajk, yajk->IJ', v_caca_so, t1_aecc, t1_aecc,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xi, xyiz, yz->IJ', h_ac_so, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xi, xyiz, zy->IJ', h_ac_so, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ix, iy, xy->IJ', h_ca_so, t1_ca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ix, iy, yx->IJ', h_ca_so, t1_ca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ax, ay, xy->IJ', h_ea_so, t1_ea, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ax, ay, yx->IJ', h_ea_so, t1_ea, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ai, axiy, xy->IJ', h_ec_so, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ai, axiy, yx->IJ', h_ec_so, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyiz, xyiw, wz->IJ', t1_aaca, v_aaca_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xyiz, xjij, yz->IJ', t1_aaca, v_accc_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyiz, iwxy, zw->IJ', t1_aaca, v_caaa_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xyiz, ijxj, zy->IJ', t1_aaca, v_ccac_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyij, xzij, yz->IJ', t1_aacc, v_aacc_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyij, ijxz, zy->IJ', t1_aacc, v_ccaa_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xi, xyiz, zy->IJ', t1_ac, v_aaca_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ix, iyxz, zy->IJ', t1_ca, v_caaa_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ix, ijjy, yx->IJ', t1_ca, v_ccca_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ix, jyij, xy->IJ', t1_ca, v_cacc_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ia, ixay, yx->IJ', t1_ce, v_caea_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ax, aiiy, yx->IJ', t1_ea, v_ecca_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ax, iyai, xy->IJ', t1_ea, v_caec_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('axiy, axiz, zy->IJ', t1_eaca, v_eaca_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('axiy, ajij, xy->IJ', t1_eaca, v_eccc_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('axiy, izax, yz->IJ', t1_eaca, v_caea_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('axiy, ijaj, yx->IJ', t1_eaca, v_ccec_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('axij, ayij, xy->IJ', t1_eacc, v_eacc_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('axij, ijay, yx->IJ', t1_eacc, v_ccea_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ai, axiy, yx->IJ', t1_ec, v_eaca_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('abix, abiy, yx->IJ', t1_eeca, v_eeca_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('abix, iyab, xy->IJ', t1_eeca, v_caee_so, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('i, ix, iy, xy->IJ', e_core_so, t1_ca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, ix, xyiz, yz->IJ', e_core_so, t1_ca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, ix, xyiz, zy->IJ', e_core_so, t1_ca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, ia, axiy, xy->IJ', e_core_so, t1_ce, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, ia, axiy, yx->IJ', e_core_so, t1_ce, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, xyiz, ix, yz->IJ', e_core_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, xyiz, ix, zy->IJ', e_core_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('i, xyiz, xyiw, zw->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('i, xyiz, xyiw, wz->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('i, xyij, xzij, yz->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('i, xyij, xzij, zy->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, xaiy, xaiz, yz->IJ', e_core_so, t1_aeca, t1_aeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, xaiy, xaiz, zy->IJ', e_core_so, t1_aeca, t1_aeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, axiy, ia, xy->IJ', e_core_so, t1_eaca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, axiy, ia, yx->IJ', e_core_so, t1_eaca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('i, axij, ayij, xy->IJ', e_core_so, t1_eacc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('i, axij, ayij, yx->IJ', e_core_so, t1_eacc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('i, abix, abiy, xy->IJ', e_core_so, t1_eeca, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('i, abix, abiy, yx->IJ', e_core_so, t1_eeca, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('a, ax, ay, xy->IJ', e_extern_so, t1_ea, t1_ea, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('a, axiy, axiz, yz->IJ', e_extern_so, t1_eaca, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('a, axiy, ai, yx->IJ', e_extern_so, t1_eaca, t1_ec, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('a, axij, ayij, yx->IJ', e_extern_so, t1_eacc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('a, ai, axiy, xy->IJ', e_extern_so, t1_ec, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('a, abix, abiy, xy->IJ', e_extern_so, t1_eeca, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('xy, xziw, yziu, wu->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xziw, zi, yw->IJ', h_aa_so, t1_aaca, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xziw, zi, wy->IJ', h_aa_so, t1_aaca, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xzij, ywij, zw->IJ', h_aa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, xzij, zwij, yw->IJ', h_aa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, xzij, zwij, wy->IJ', h_aa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('xy, xi, yziw, zw->IJ', h_aa_so, t1_ac, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('xy, xi, yziw, wz->IJ', h_aa_so, t1_ac, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xi, iz, yz->IJ', h_aa_so, t1_ac, t1_ca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xi, iz, zy->IJ', h_aa_so, t1_ac, t1_ca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xa, az, yz->IJ', h_aa_so, t1_ae, t1_ea, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xa, az, zy->IJ', h_aa_so, t1_ae, t1_ea, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('xy, xaiz, yaiw, zw->IJ', h_aa_so, t1_aeca, t1_aeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xaiz, ai, yz->IJ', h_aa_so, t1_aeca, t1_ec, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xaiz, ai, zy->IJ', h_aa_so, t1_aeca, t1_ec, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, xaij, azij, yz->IJ', h_aa_so, t1_aecc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, xaij, azij, zy->IJ', h_aa_so, t1_aecc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, zwxi, zwiu, yu->IJ', h_aa_so, t1_aaac, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, zwxi, zwiu, uy->IJ', h_aa_so, t1_aaac, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, zwxi, zi, yw->IJ', h_aa_so, t1_aaac, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, zwxi, zi, wy->IJ', h_aa_so, t1_aaac, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, zaxi, zaiw, yw->IJ', h_aa_so, t1_aeac, t1_aeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, zaxi, zaiw, wy->IJ', h_aa_so, t1_aeac, t1_aeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, azxi, ai, yz->IJ', h_aa_so, t1_eaac, t1_ec, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, azxi, ai, zy->IJ', h_aa_so, t1_eaac, t1_ec, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, abxi, abiz, yz->IJ', h_aa_so, t1_eeac, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, abxi, abiz, zy->IJ', h_aa_so, t1_eeac, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, xyiu, zwiv, vu->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xyzw, xyiu, zi, wu->IJ', v_aaaa_so, t1_aaca, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, xyij, zuij, wu->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, xuij, zwij, uy->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xyzw, xuij, zuij, wy->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xyzw, xi, zwiu, uy->IJ', v_aaaa_so, t1_ac, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('xyzw, xi, zi, wy->IJ', v_aaaa_so, t1_ac, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xyzw, xaij, zaij, wy->IJ', v_aaaa_so, t1_aecc, t1_aecc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('ixiy, xzjw, yzju, uw->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('ixiy, xzjw, yj, zw->IJ', v_caca_so, t1_aaca, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, xzjw, zj, yw->IJ', v_caca_so, t1_aaca, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, xzjk, ywjk, zw->IJ', v_caca_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, xzjk, zwjk, yw->IJ', v_caca_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('ixiy, xj, yzjw, wz->IJ', v_caca_so, t1_ac, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, xj, jz, yz->IJ', v_caca_so, t1_ac, t1_ca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, xa, az, yz->IJ', v_caca_so, t1_ae, t1_ea, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += np.einsum('ixiy, xajz, yajw, wz->IJ', v_caca_so, t1_aeca, t1_aeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, xajz, aj, yz->IJ', v_caca_so, t1_aeca, t1_ec, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, xajk, azjk, yz->IJ', v_caca_so, t1_aecc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, yzjw, zj, wx->IJ', v_caca_so, t1_aaca, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, yzjk, zwjk, wx->IJ', v_caca_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, yj, jz, zx->IJ', v_caca_so, t1_ac, t1_ca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, ya, az, zx->IJ', v_caca_so, t1_ae, t1_ea, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, yajz, aj, zx->IJ', v_caca_so, t1_aeca, t1_ec, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, yajk, azjk, zx->IJ', v_caca_so, t1_aecc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, zwxj, zwju, yu->IJ', v_caca_so, t1_aaac, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, zwxj, zj, yw->IJ', v_caca_so, t1_aaac, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, zwyj, zwju, ux->IJ', v_caca_so, t1_aaac, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, zwyj, zj, wx->IJ', v_caca_so, t1_aaac, t1_ac, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, zaxj, zajw, yw->IJ', v_caca_so, t1_aeac, t1_aeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, zayj, zajw, wx->IJ', v_caca_so, t1_aeac, t1_aeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, azxj, aj, yz->IJ', v_caca_so, t1_eaac, t1_ec, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, azyj, aj, zx->IJ', v_caca_so, t1_eaac, t1_ec, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, abxj, abjz, yz->IJ', v_caca_so, t1_eeac, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, abyj, abjz, zx->IJ', v_caca_so, t1_eeac, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ix, yziw, xwyz->IJ', h_ca_so, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ix, yziw, yzxw->IJ', h_ca_so, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ax, ayzw, xyzw->IJ', h_ea_so, t1_eaaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ax, ayzw, zwxy->IJ', h_ea_so, t1_eaaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xyiz, xwiu, yuzw->IJ', t1_aaca, v_aaca_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xyiz, iwxu, zuyw->IJ', t1_aaca, v_caaa_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyiz, ijjw, zwxy->IJ', t1_aaca, v_ccca_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyiz, jwij, xyzw->IJ', t1_aaca, v_cacc_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyij, ijzw, zwxy->IJ', t1_aacc, v_ccaa_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyij, zwij, xyzw->IJ', t1_aacc, v_aacc_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ix, iyzw, zwxy->IJ', t1_ca, v_caaa_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ix, yziw, xwyz->IJ', t1_ca, v_aaca_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ax, ayzw, zwxy->IJ', t1_ea, v_eaaa_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ax, yzaw, xwyz->IJ', t1_ea, v_aaea_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('axyz, axwu, wuyz->IJ', t1_eaaa, v_eaaa_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('axyz, aiiw, xwyz->IJ', t1_eaaa, v_ecca_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('axyz, wuax, yzwu->IJ', t1_eaaa, v_aaea_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('axyz, iwai, yzxw->IJ', t1_eaaa, v_caec_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('axiy, aziw, xwyz->IJ', t1_eaca, v_eaca_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('axiy, izaw, ywxz->IJ', t1_eaca, v_caea_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('abxy, abzw, zwxy->IJ', t1_eeaa, v_eeaa_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('abxy, zwab, xyzw->IJ', t1_eeaa, v_aaee_so, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('i, ix, yziw, xwyz->IJ', e_core_so, t1_ca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('i, xyiz, iw, xyzw->IJ', e_core_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('i, xyiz, xwiu, yuzw->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('i, xyiz, xwiu, zwyu->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('i, xyiz, wuiz, xywu->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('i, xyiz, wuiz, wuxy->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('i, xyij, zwij, xyzw->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('i, xyij, zwij, zwxy->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('i, axiy, aziw, xwyz->IJ', e_core_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('i, axiy, aziw, yzxw->IJ', e_core_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('a, ax, ayzw, xyzw->IJ', e_extern_so, t1_ea, t1_eaaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('a, axyz, axwu, yzwu->IJ', e_extern_so, t1_eaaa, t1_eaaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('a, axyz, aw, yzxw->IJ', e_extern_so, t1_eaaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('a, axiy, aziw, yzxw->IJ', e_extern_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('a, abxy, abzw, xyzw->IJ', e_extern_so, t1_eeaa, t1_eeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, xzwi, uvwi, yzuv->IJ', h_aa_so, t1_aaac, t1_aaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, xzwi, uvwi, uvyz->IJ', h_aa_so, t1_aaac, t1_aaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('xy, xziw, yuiv, zvwu->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, xziw, zuiv, yvwu->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, xziw, zuiv, wuyv->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xziw, iu, yzwu->IJ', h_aa_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, xziw, iu, wuyz->IJ', h_aa_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, xziw, uviw, yzuv->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, xziw, uviw, uvyz->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xy, xzij, wuij, yzwu->IJ', h_aa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xy, xzij, wuij, wuyz->IJ', h_aa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, xi, zwiu, yuzw->IJ', h_aa_so, t1_ac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, xi, zwiu, zwyu->IJ', h_aa_so, t1_ac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, xa, azwu, yzwu->IJ', h_aa_so, t1_ae, t1_eaaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, xa, azwu, wuyz->IJ', h_aa_so, t1_ae, t1_eaaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, xazw, yauv, zwuv->IJ', h_aa_so, t1_aeaa, t1_aeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, xazw, au, yuzw->IJ', h_aa_so, t1_aeaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, xazw, au, zwyu->IJ', h_aa_so, t1_aeaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, xaiz, awiu, yuzw->IJ', h_aa_so, t1_aeca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xy, xaiz, awiu, zwyu->IJ', h_aa_so, t1_aeca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, zwxi, zuiv, yuwv->IJ', h_aa_so, t1_aaac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, zwxi, zuiv, wvyu->IJ', h_aa_so, t1_aaac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, zwxi, iu, yuzw->IJ', h_aa_so, t1_aaac, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, zwxi, iu, zwyu->IJ', h_aa_so, t1_aaac, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, zaxw, zauv, ywuv->IJ', h_aa_so, t1_aeaa, t1_aeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xy, zaxw, zauv, uvyw->IJ', h_aa_so, t1_aeaa, t1_aeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, azxw, au, ywzu->IJ', h_aa_so, t1_eaaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, azxw, au, zuyw->IJ', h_aa_so, t1_eaaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, azxi, awiu, ywzu->IJ', h_aa_so, t1_eaac, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xy, azxi, awiu, zuyw->IJ', h_aa_so, t1_eaac, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xy, abxz, abwu, yzwu->IJ', h_aa_so, t1_eeaa, t1_eeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xy, abxz, abwu, wuyz->IJ', h_aa_so, t1_eeaa, t1_eeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.0625 * np.einsum('xyzw, xyui, vsui, zwvs->IJ', v_aaaa_so, t1_aaac, t1_aaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('xyzw, xyiu, zvis, wsuv->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, xyiu, iv, zwuv->IJ', v_aaaa_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, xyiu, vsiu, zwvs->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.03125 * np.einsum('xyzw, xyij, uvij, zwuv->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xyzw, xuiv, zwis, usyv->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('xyzw, xuiv, zuis, wsyv->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('xyzw, xuiv, zi, wuyv->IJ', v_aaaa_so, t1_aaca, t1_ac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, xuiv, ui, zwyv->IJ', v_aaaa_so, t1_aaca, t1_ac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, xuiv, usyi, zwvs->IJ', v_aaaa_so, t1_aaca, t1_aaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('xyzw, xuij, zvij, wuyv->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, xuij, uvij, zwyv->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('xyzw, xi, zuiv, wvyu->IJ', v_aaaa_so, t1_ac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, xi, iu, zwyu->IJ', v_aaaa_so, t1_ac, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, xi, uvyi, zwuv->IJ', v_aaaa_so, t1_ac, t1_aaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, xa, yauv, zwuv->IJ', v_aaaa_so, t1_ae, t1_aeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, xa, au, zwyu->IJ', v_aaaa_so, t1_ae, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('xyzw, xaiu, zaiv, wvyu->IJ', v_aaaa_so, t1_aeca, t1_aeca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, xaiu, ai, zwyu->IJ', v_aaaa_so, t1_aeca, t1_ec, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, xaiu, avyi, zwuv->IJ', v_aaaa_so, t1_aeca, t1_eaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, xaij, auij, zwyu->IJ', v_aaaa_so, t1_aecc, t1_eacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.0625 * np.einsum('xyzw, zwui, vsui, vsxy->IJ', v_aaaa_so, t1_aaac, t1_aaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, zwiu, iv, uvxy->IJ', v_aaaa_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, zwiu, vsiu, vsxy->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.03125 * np.einsum('xyzw, zwij, uvij, uvxy->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, zuiv, ui, wvxy->IJ', v_aaaa_so, t1_aaca, t1_ac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, zuiv, uswi, vsxy->IJ', v_aaaa_so, t1_aaca, t1_aaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, zuij, uvij, wvxy->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, zi, iu, wuxy->IJ', v_aaaa_so, t1_ac, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, zi, uvwi, uvxy->IJ', v_aaaa_so, t1_ac, t1_aaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, za, wauv, uvxy->IJ', v_aaaa_so, t1_ae, t1_aeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, za, au, wuxy->IJ', v_aaaa_so, t1_ae, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, zaiu, ai, wuxy->IJ', v_aaaa_so, t1_aeca, t1_ec, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, zaiu, avwi, uvxy->IJ', v_aaaa_so, t1_aeca, t1_eaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, zaij, auij, wuxy->IJ', v_aaaa_so, t1_aecc, t1_eacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, uvxi, uvis, zwys->IJ', v_aaaa_so, t1_aaac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, uvxi, ui, zwyv->IJ', v_aaaa_so, t1_aaac, t1_ac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, uvzi, uvis, wsxy->IJ', v_aaaa_so, t1_aaac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, uvzi, ui, wvxy->IJ', v_aaaa_so, t1_aaac, t1_ac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.0625 * np.einsum('xyzw, uaxy, uavs, zwvs->IJ', v_aaaa_so, t1_aeaa, t1_aeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, uaxi, uaiv, zwyv->IJ', v_aaaa_so, t1_aeac, t1_aeca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.0625 * np.einsum('xyzw, uazw, uavs, vsxy->IJ', v_aaaa_so, t1_aeaa, t1_aeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, uazi, uaiv, wvxy->IJ', v_aaaa_so, t1_aeac, t1_aeca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, auxy, av, zwuv->IJ', v_aaaa_so, t1_eaaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, auxi, ai, zwyu->IJ', v_aaaa_so, t1_eaac, t1_ec, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, auzw, av, uvxy->IJ', v_aaaa_so, t1_eaaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, auzi, ai, wuxy->IJ', v_aaaa_so, t1_eaac, t1_ec, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.03125 * np.einsum('xyzw, abxy, abuv, zwuv->IJ', v_aaaa_so, t1_eeaa, t1_eeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, abxi, abiu, zwyu->IJ', v_aaaa_so, t1_eeac, t1_eeca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.03125 * np.einsum('xyzw, abzw, abuv, uvxy->IJ', v_aaaa_so, t1_eeaa, t1_eeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, abzi, abiu, wuxy->IJ', v_aaaa_so, t1_eeac, t1_eeca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, xzwj, uvwj, yzuv->IJ', v_caca_so, t1_aaac, t1_aaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('ixiy, xzjw, yujv, zvwu->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, xzjw, zujv, yvwu->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, xzjw, ju, yzwu->IJ', v_caca_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, xzjw, uvjw, yzuv->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('ixiy, xzjk, wujk, yzwu->IJ', v_caca_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, xj, zwju, yuzw->IJ', v_caca_so, t1_ac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, xa, azwu, yzwu->IJ', v_caca_so, t1_ae, t1_eaaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, xazw, yauv, uvzw->IJ', v_caca_so, t1_aeaa, t1_aeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, xazw, au, yuzw->IJ', v_caca_so, t1_aeaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, xajz, awju, yuzw->IJ', v_caca_so, t1_aeca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, yzwj, uvwj, uvxz->IJ', v_caca_so, t1_aaac, t1_aaac, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, yzjw, zujv, wuxv->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, yzjw, ju, wuxz->IJ', v_caca_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, yzjw, uvjw, uvxz->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('ixiy, yzjk, wujk, wuxz->IJ', v_caca_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, yj, zwju, zwxu->IJ', v_caca_so, t1_ac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, ya, azwu, wuxz->IJ', v_caca_so, t1_ae, t1_eaaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, yazw, au, zwxu->IJ', v_caca_so, t1_aeaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.5 * np.einsum('ixiy, yajz, awju, zwxu->IJ', v_caca_so, t1_aeca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, zwxj, zujv, yuwv->IJ', v_caca_so, t1_aaac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, zwxj, ju, yuzw->IJ', v_caca_so, t1_aaac, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, zwyj, zujv, wvxu->IJ', v_caca_so, t1_aaac, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, zwyj, ju, zwxu->IJ', v_caca_so, t1_aaac, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, zaxw, zauv, ywuv->IJ', v_caca_so, t1_aeaa, t1_aeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('ixiy, zayw, zauv, uvxw->IJ', v_caca_so, t1_aeaa, t1_aeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, azxw, au, ywzu->IJ', v_caca_so, t1_eaaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, azxj, awju, ywzu->IJ', v_caca_so, t1_eaac, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, azyw, au, zuxw->IJ', v_caca_so, t1_eaaa, t1_ea, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.5 * np.einsum('ixiy, azyj, awju, zuxw->IJ', v_caca_so, t1_eaac, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('ixiy, abxz, abwu, yzwu->IJ', v_caca_so, t1_eeaa, t1_eeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('ixiy, abyz, abwu, wuxz->IJ', v_caca_so, t1_eeaa, t1_eeaa, rdm_ccaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyiz, iwuv, zuvxyw->IJ', t1_aaca, v_caaa_so, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyiz, wuiv, xyvzwu->IJ', t1_aaca, v_aaca_so, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('axyz, awuv, xuvyzw->IJ', t1_eaaa, v_eaaa_so, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('axyz, wuav, yzvxwu->IJ', t1_eaaa, v_aaea_so, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('i, xyiz, wuiv, xyvzwu->IJ', e_core_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('a, axyz, awuv, yzwxuv->IJ', e_extern_so, t1_eaaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, xziw, uvis, yzswuv->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, xziw, uvis, wuvyzs->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xy, xazw, auvs, yvszwu->IJ', h_aa_so, t1_aeaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xy, xazw, auvs, zwuyvs->IJ', h_aa_so, t1_aeaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xy, zwxi, uvis, yuvzws->IJ', h_aa_so, t1_aaac, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xy, zwxi, uvis, zwsyuv->IJ', h_aa_so, t1_aaac, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, azxw, auvs, ywuzvs->IJ', h_aa_so, t1_eaaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xy, azxw, auvs, zvsywu->IJ', h_aa_so, t1_eaaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, xyiu, vsit, zwtuvs->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, xuvi, stvi, zwuyst->IJ', v_aaaa_so, t1_aaac, t1_aaac, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= np.einsum('xyzw, xuiv, zsit, wutyvs->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, xuiv, usit, zwtyvs->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, xuiv, is, zwuyvs->IJ', v_aaaa_so, t1_aaca, t1_ca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, xuiv, styi, zwuvst->IJ', v_aaaa_so, t1_aaca, t1_aaac, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, xuiv, stiv, zwuyst->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.0625 * np.einsum('xyzw, xuij, vsij, zwuyvs->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, xi, uvis, zwsyuv->IJ', v_aaaa_so, t1_ac, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, xa, auvs, zwuyvs->IJ', v_aaaa_so, t1_ae, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, xauv, zast, wstyuv->IJ', v_aaaa_so, t1_aeaa, t1_aeaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, xauv, as, zwsyuv->IJ', v_aaaa_so, t1_aeaa, t1_ea, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, xauv, asyt, zwtuvs->IJ', v_aaaa_so, t1_aeaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, xaiu, avis, zwsyuv->IJ', v_aaaa_so, t1_aeca, t1_eaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, zwiu, vsit, uvsxyt->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, zuvi, stvi, wstxyu->IJ', v_aaaa_so, t1_aaac, t1_aaac, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, zuiv, usit, wvsxyt->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, zuiv, is, wvsxyu->IJ', v_aaaa_so, t1_aaca, t1_ca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, zuiv, stwi, vstxyu->IJ', v_aaaa_so, t1_aaca, t1_aaac, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, zuiv, stiv, wstxyu->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.0625 * np.einsum('xyzw, zuij, vsij, wvsxyu->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, zi, uvis, wuvxys->IJ', v_aaaa_so, t1_ac, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, za, auvs, wvsxyu->IJ', v_aaaa_so, t1_ae, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, zauv, as, wuvxys->IJ', v_aaaa_so, t1_aeaa, t1_ea, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, zauv, aswt, uvsxyt->IJ', v_aaaa_so, t1_aeaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('xyzw, zaiu, avis, wuvxys->IJ', v_aaaa_so, t1_aeca, t1_eaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, uvxi, usit, zwsyvt->IJ', v_aaaa_so, t1_aaac, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, uvxi, is, zwsyuv->IJ', v_aaaa_so, t1_aaac, t1_ca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, uvzi, usit, wvtxys->IJ', v_aaaa_so, t1_aaac, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.125 * np.einsum('xyzw, uvzi, is, wuvxys->IJ', v_aaaa_so, t1_aaac, t1_ca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, uaxv, uast, zwvyst->IJ', v_aaaa_so, t1_aeaa, t1_aeaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, uazv, uast, wstxyv->IJ', v_aaaa_so, t1_aeaa, t1_aeaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, auxy, avst, zwvust->IJ', v_aaaa_so, t1_eaaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, auxv, as, zwvyus->IJ', v_aaaa_so, t1_eaaa, t1_ea, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, auxi, avis, zwvyus->IJ', v_aaaa_so, t1_eaac, t1_eaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, auzw, avst, ustxyv->IJ', v_aaaa_so, t1_eaaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, auzv, as, wusxyv->IJ', v_aaaa_so, t1_eaaa, t1_ea, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] += 0.25 * np.einsum('xyzw, auzi, avis, wusxyv->IJ', v_aaaa_so, t1_eaac, t1_eaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, abxu, abvs, zwuyvs->IJ', v_aaaa_so, t1_eeaa, t1_eeaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, abzu, abvs, wvsxyu->IJ', v_aaaa_so, t1_eeaa, t1_eeaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, xzjw, uvjs, yzswuv->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('ixiy, xazw, auvs, yvszwu->IJ', v_caca_so, t1_aeaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, yzjw, uvjs, wuvxzs->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('ixiy, yazw, auvs, zwuxvs->IJ', v_caca_so, t1_aeaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('ixiy, zwxj, uvjs, yuvzws->IJ', v_caca_so, t1_aaac, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('ixiy, zwyj, uvjs, zwsxuv->IJ', v_caca_so, t1_aaac, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, azxw, auvs, ywuzvs->IJ', v_caca_so, t1_eaaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.25 * np.einsum('ixiy, azyw, auvs, zvsxwu->IJ', v_caca_so, t1_eaaa, t1_eaaa, rdm_cccaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, xuiv, stir, zwuryvst->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccccaaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, xauv, astr, zwtryuvs->IJ', v_aaaa_so, t1_aeaa, t1_eaaa, rdm_ccccaaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, zuiv, stir, wvstxyur->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccccaaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, zauv, astr, wuvsxytr->IJ', v_aaaa_so, t1_aeaa, t1_eaaa, rdm_ccccaaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, uvxi, stir, zwstyuvr->IJ', v_aaaa_so, t1_aaac, t1_aaca, rdm_ccccaaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.0625 * np.einsum('xyzw, uvzi, stir, wuvrxyst->IJ', v_aaaa_so, t1_aaac, t1_aaca, rdm_ccccaaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, auxv, astr, zwvsyutr->IJ', v_aaaa_so, t1_eaaa, t1_eaaa, rdm_ccccaaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()
        M[sI:fI, sI:fI] -= 0.125 * np.einsum('xyzw, auzv, astr, wutrxyvs->IJ', v_aaaa_so, t1_eaaa, t1_eaaa, rdm_ccccaaaa_so,optimize = True).reshape(ni_cas, ni_cas).copy()

#        M[sI:fI, sI:fI] = M[sI:fI, sI:fI].T.copy()

    # I - i
    if ncore_so > 0:
        print "Computing M(I - i)..."
        sys.stdout.flush()

        M[sI:fI, si:fi] =- np.einsum('J, Jx, Ix->IJ', e_core_so, t2_ca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('Ja, ax, Ix->IJ', h_ce_so, t1_ea, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xi, xyJi, Iy->IJ', h_ac_so, t1_aacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ax, Ja, Ix->IJ', h_ea_so, t1_ce, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ai, axJi, Ix->IJ', h_ec_so, t1_eacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += np.einsum('xy, Jx, Iy->IJ', h_aa_so, t2_ca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('Ja, aiix, Ix->IJ', t1_ce, v_ecca_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyJi, xyiz, Iz->IJ', t1_aacc, v_aaca_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xyJi, xjij, Iy->IJ', t1_aacc, v_accc_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyiz, Jixy, Iz->IJ', t1_aaca, v_ccaa_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyij, Jxij, Iy->IJ', t1_aacc, v_cacc_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xi, Jxiy, Iy->IJ', t1_ac, v_caca_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xaJi, xaiy, Iy->IJ', t1_aecc, v_aeca_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xaiy, Jixa, Iy->IJ', t1_aeca, v_ccae_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ix, Jixy, Iy->IJ', t1_ca, v_ccaa_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ia, Jiax, Ix->IJ', t1_ce, v_ccea_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ax, Jiai, Ix->IJ', t1_ea, v_ccec_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('axJi, ajij, Ix->IJ', t1_eacc, v_eccc_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('axij, Jaij, Ix->IJ', t1_eacc, v_cecc_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ai, Jaix, Ix->IJ', t1_ec, v_ceca_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('abJi, abix, Ix->IJ', t1_eecc, v_eeca_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('abix, Jiab, Ix->IJ', t1_eeca, v_ccee_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('Jx, xiiy, Iy->IJ', t2_ca, v_acca_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('J, Ja, ax, Ix->IJ', e_core_so, t1_ce, t1_ea, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('J, xyJi, xyiz, Iz->IJ', e_core_so, t1_aacc, t1_aaca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('J, xyJi, xi, Iy->IJ', e_core_so, t1_aacc, t1_ac, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('J, axJi, axiy, Iy->IJ', e_core_so, t1_eacc, t1_eaca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('J, axJi, ai, Ix->IJ', e_core_so, t1_eacc, t1_ec, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('J, abJi, abix, Ix->IJ', e_core_so, t1_eecc, t1_eeca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('i, ix, xyJi, Iy->IJ', e_core_so, t1_ca, t1_aacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('i, ia, axJi, Ix->IJ', e_core_so, t1_ce, t1_eacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('i, xyJi, ix, Iy->IJ', e_core_so, t1_aacc, t1_ca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('i, xyJi, xyiz, Iz->IJ', e_core_so, t1_aacc, t1_aaca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('i, xyiz, xyJi, Iz->IJ', e_core_so, t1_aaca, t1_aacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('i, axJi, ia, Ix->IJ', e_core_so, t1_eacc, t1_ce, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('i, axJi, axiy, Iy->IJ', e_core_so, t1_eacc, t1_eaca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('i, axiy, axJi, Iy->IJ', e_core_so, t1_eaca, t1_eacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('i, abJi, abix, Ix->IJ', e_core_so, t1_eecc, t1_eeca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('i, abix, abJi, Ix->IJ', e_core_so, t1_eeca, t1_eecc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += np.einsum('a, ax, Ja, Ix->IJ', e_extern_so, t1_ea, t1_ce, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('a, axiy, axJi, Iy->IJ', e_extern_so, t1_eaca, t1_eacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('a, ai, axJi, Ix->IJ', e_extern_so, t1_ec, t1_eacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('a, abix, abJi, Ix->IJ', e_extern_so, t1_eeca, t1_eecc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xy, iz, Jxyi, Iz->IJ', rdm_ca_so, t1_ca, v_caac_so, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('xy, xzJi, yziw, Iw->IJ', h_aa_so, t1_aacc, t1_aaca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('xy, xzJi, yi, Iz->IJ', h_aa_so, t1_aacc, t1_ac, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xy, xzJi, zi, Iy->IJ', h_aa_so, t1_aacc, t1_ac, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xy, xa, Ja, Iy->IJ', h_aa_so, t1_ae, t1_ce, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('xy, xaJi, yaiz, Iz->IJ', h_aa_so, t1_aecc, t1_aeca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xy, xaJi, ai, Iy->IJ', h_aa_so, t1_aecc, t1_ec, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xy, zwxi, zwJi, Iy->IJ', h_aa_so, t1_aaac, t1_aacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xy, azxi, azJi, Iy->IJ', h_aa_so, t1_eaac, t1_eacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xy, abxi, abJi, Iy->IJ', h_aa_so, t1_eeac, t1_eecc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzw, xyJi, zwiu, Iu->IJ', v_aaaa_so, t1_aacc, t1_aaca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xyzw, xyJi, zi, Iw->IJ', v_aaaa_so, t1_aacc, t1_ac, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('ixiy, xzJj, yzjw, Iw->IJ', v_caca_so, t1_aacc, t1_aaca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('ixiy, xzJj, yj, Iz->IJ', v_caca_so, t1_aacc, t1_ac, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ixiy, xzJj, zj, Iy->IJ', v_caca_so, t1_aacc, t1_ac, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ixiy, xa, Ja, Iy->IJ', v_caca_so, t1_ae, t1_ce, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('ixiy, xaJj, yajz, Iz->IJ', v_caca_so, t1_aecc, t1_aeca, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ixiy, xaJj, aj, Iy->IJ', v_caca_so, t1_aecc, t1_ec, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('ixiy, zwxj, zwJj, Iy->IJ', v_caca_so, t1_aaac, t1_aacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ixiy, azxj, azJj, Iy->IJ', v_caca_so, t1_eaac, t1_eacc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('ixiy, abxj, abJj, Iy->IJ', v_caca_so, t1_eeac, t1_eecc, trdm_c_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('J, xyJz, Ixyz->IJ', e_core_so, t2_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('Ja, axyz, Iyzx->IJ', h_ce_so, t1_eaaa, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('ix, yzJi, Iyzx->IJ', h_ca_so, t1_aacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ax, ayJz, Ixyz->IJ', h_ea_so, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += np.einsum('xy, xzJw, Iyzw->IJ', h_aa_so, t2_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xy, zwJx, Izwy->IJ', h_aa_so, t2_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('Ja, axyz, Iyzx->IJ', t1_ce, v_eaaa_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xyJi, xziw, Iywz->IJ', t1_aacc, v_aaca_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyJi, jzij, Ixyz->IJ', t1_aacc, v_cacc_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzi, Jwzi, Ixyw->IJ', t1_aaac, v_caac_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xyiz, Jxiw, Iywz->IJ', t1_aaca, v_caca_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xyiz, Jixw, Izwy->IJ', t1_aaca, v_ccaa_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyiz, Jwiz, Ixyw->IJ', t1_aaca, v_caca_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyij, Jzij, Ixyz->IJ', t1_aacc, v_cacc_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xaJy, xazw, Izwy->IJ', t1_aeca, v_aeaa_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xayz, Jwxa, Iyzw->IJ', t1_aeaa, v_caae_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('ix, Jiyz, Iyzx->IJ', t1_ca, v_ccaa_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ix, Jyiz, Ixzy->IJ', t1_ca, v_caca_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('ax, Jayz, Iyzx->IJ', t1_ea, v_ceaa_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ax, Jyaz, Ixzy->IJ', t1_ea, v_caea_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('axJy, aiiz, Ixzy->IJ', t1_eaca, v_ecca_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('axJi, ayiz, Ixzy->IJ', t1_eacc, v_eaca_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('axyz, Jiai, Iyzx->IJ', t1_eaaa, v_ccec_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('axiy, Jaiz, Ixzy->IJ', t1_eaca, v_ceca_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('axiy, Jiaz, Iyzx->IJ', t1_eaca, v_ccea_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('abJx, abyz, Iyzx->IJ', t1_eeca, v_eeaa_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('abxy, Jzab, Ixyz->IJ', t1_eeaa, v_caee_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('Jx, xyzw, Izwy->IJ', t2_ca, v_aaaa_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyJz, xywu, Iwuz->IJ', t2_aaca, v_aaaa_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += np.einsum('xyJz, xiiw, Iywz->IJ', t2_aaca, v_acca_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xyJz, iwzi, Ixyw->IJ', t2_aaca, v_caac_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('J, Ja, axyz, Iyzx->IJ', e_core_so, t1_ce, t1_eaaa, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('J, xyJi, xziw, Iywz->IJ', e_core_so, t1_aacc, t1_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('J, xyJi, iz, Ixyz->IJ', e_core_so, t1_aacc, t1_ca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('J, axJy, axzw, Izwy->IJ', e_core_so, t1_eaca, t1_eaaa, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('J, axJy, az, Ixzy->IJ', e_core_so, t1_eaca, t1_ea, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('J, axJi, ayiz, Ixzy->IJ', e_core_so, t1_eacc, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('J, abJx, abyz, Iyzx->IJ', e_core_so, t1_eeca, t1_eeaa, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('i, xyJi, iz, Ixyz->IJ', e_core_so, t1_aacc, t1_ca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('i, xyJi, xziw, Iywz->IJ', e_core_so, t1_aacc, t1_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('i, xyiz, xwJi, Izwy->IJ', e_core_so, t1_aaca, t1_aacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('i, axJi, ayiz, Ixzy->IJ', e_core_so, t1_eacc, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('i, axiy, azJi, Iyzx->IJ', e_core_so, t1_eaca, t1_eacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += np.einsum('a, ax, ayJz, Ixyz->IJ', e_extern_so, t1_ea, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('a, axyz, Ja, Iyzx->IJ', e_extern_so, t1_eaaa, t1_ce, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('a, axyz, axJw, Iyzw->IJ', e_extern_so, t1_eaaa, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += np.einsum('a, axiy, azJi, Iyzx->IJ', e_extern_so, t1_eaca, t1_eacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('a, abxy, abJz, Ixyz->IJ', e_extern_so, t1_eeaa, t1_eeca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xy, zwiu, Jxyi, Izwu->IJ', rdm_ca_so, t1_aaca, v_caac_so, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('xy, xzJi, ywiu, Izuw->IJ', h_aa_so, t1_aacc, t1_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xy, xzJi, zwiu, Iyuw->IJ', h_aa_so, t1_aacc, t1_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xy, xzJi, iw, Iyzw->IJ', h_aa_so, t1_aacc, t1_ca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xy, xziw, zuJi, Iwuy->IJ', h_aa_so, t1_aaca, t1_aacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xy, xi, zwJi, Izwy->IJ', h_aa_so, t1_ac, t1_aacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xy, xa, azJw, Iyzw->IJ', h_aa_so, t1_ae, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xy, xaJz, yawu, Iwuz->IJ', h_aa_so, t1_aeca, t1_aeaa, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xy, xaJz, aw, Iywz->IJ', h_aa_so, t1_aeca, t1_ea, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xy, xaJi, aziw, Iywz->IJ', h_aa_so, t1_aecc, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xy, xazw, Ja, Izwy->IJ', h_aa_so, t1_aeaa, t1_ce, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xy, xaiz, awJi, Izwy->IJ', h_aa_so, t1_aeca, t1_eacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xy, zwxi, zuJi, Iyuw->IJ', h_aa_so, t1_aaac, t1_aacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xy, azJx, azwu, Iwuy->IJ', h_aa_so, t1_eaca, t1_eaaa, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xy, azJx, aw, Izwy->IJ', h_aa_so, t1_eaca, t1_ea, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xy, azxw, Ja, Iywz->IJ', h_aa_so, t1_eaaa, t1_ce, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xy, azxw, azJu, Iywu->IJ', h_aa_so, t1_eaaa, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xy, azxi, awJi, Iywz->IJ', h_aa_so, t1_eaac, t1_eacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('xy, abJx, abzw, Izwy->IJ', h_aa_so, t1_eeca, t1_eeaa, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xy, abxz, abJw, Iyzw->IJ', h_aa_so, t1_eeaa, t1_eeca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xyzw, xyJi, zuiv, Iwvu->IJ', v_aaaa_so, t1_aacc, t1_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('xyzw, xyJi, iu, Izwu->IJ', v_aaaa_so, t1_aacc, t1_ca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('xyzw, xuJi, zwiv, Iuvy->IJ', v_aaaa_so, t1_aacc, t1_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += np.einsum('xyzw, xuJi, zuiv, Iwvy->IJ', v_aaaa_so, t1_aacc, t1_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += np.einsum('xyzw, xuJi, zi, Iwuy->IJ', v_aaaa_so, t1_aacc, t1_ac, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, xuJi, ui, Izwy->IJ', v_aaaa_so, t1_aacc, t1_ac, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, xuJi, uvyi, Izwv->IJ', v_aaaa_so, t1_aacc, t1_aaac, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzw, xa, Ja, Izwy->IJ', v_aaaa_so, t1_ae, t1_ce, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzw, xaJu, ya, Izwu->IJ', v_aaaa_so, t1_aeca, t1_ae, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += np.einsum('xyzw, xaJi, zaiu, Iwuy->IJ', v_aaaa_so, t1_aecc, t1_aeca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, xaJi, ai, Izwy->IJ', v_aaaa_so, t1_aecc, t1_ec, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, xaJi, auyi, Izwu->IJ', v_aaaa_so, t1_aecc, t1_eaac, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('xyzw, uvxi, uvJi, Izwy->IJ', v_aaaa_so, t1_aaac, t1_aacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('xyzw, auxy, Ja, Izwu->IJ', v_aaaa_so, t1_eaaa, t1_ce, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('xyzw, auxy, auJv, Izwv->IJ', v_aaaa_so, t1_eaaa, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzw, auxi, auJi, Izwy->IJ', v_aaaa_so, t1_eaac, t1_eacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.0625 * np.einsum('xyzw, abxy, abJu, Izwu->IJ', v_aaaa_so, t1_eeaa, t1_eeca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('xyzw, abxi, abJi, Izwy->IJ', v_aaaa_so, t1_eeac, t1_eecc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('ixiy, xzJj, ywju, Izuw->IJ', v_caca_so, t1_aacc, t1_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ixiy, xzJj, zwju, Iyuw->IJ', v_caca_so, t1_aacc, t1_aaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ixiy, xzJj, jw, Iyzw->IJ', v_caca_so, t1_aacc, t1_ca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ixiy, xa, azJw, Iyzw->IJ', v_caca_so, t1_ae, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ixiy, xaJz, yawu, Iwuz->IJ', v_caca_so, t1_aeca, t1_aeaa, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ixiy, xaJz, aw, Iywz->IJ', v_caca_so, t1_aeca, t1_ea, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ixiy, xaJj, azjw, Iywz->IJ', v_caca_so, t1_aecc, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ixiy, yzjw, zuJj, Iwux->IJ', v_caca_so, t1_aaca, t1_aacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('ixiy, yj, zwJj, Izwx->IJ', v_caca_so, t1_ac, t1_aacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('ixiy, yazw, Ja, Izwx->IJ', v_caca_so, t1_aeaa, t1_ce, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ixiy, yajz, awJj, Izwx->IJ', v_caca_so, t1_aeca, t1_eacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ixiy, zwxj, zuJj, Iyuw->IJ', v_caca_so, t1_aaac, t1_aacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('ixiy, azJy, azwu, Iwux->IJ', v_caca_so, t1_eaca, t1_eaaa, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ixiy, azJy, aw, Izwx->IJ', v_caca_so, t1_eaca, t1_ea, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ixiy, azxw, Ja, Iywz->IJ', v_caca_so, t1_eaaa, t1_ce, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('ixiy, azxw, azJu, Iywu->IJ', v_caca_so, t1_eaaa, t1_eaca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ixiy, azxj, awJj, Iywz->IJ', v_caca_so, t1_eaac, t1_eacc, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('ixiy, abJy, abzw, Izwx->IJ', v_caca_so, t1_eeca, t1_eeaa, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('ixiy, abxz, abJw, Iyzw->IJ', v_caca_so, t1_eeaa, t1_eeca, trdm_cca_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyJi, zwiu, Ixyuzw->IJ', t1_aacc, v_aaca_so, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyiz, Jiwu, Izwuxy->IJ', t1_aaca, v_ccaa_so, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyiz, Jwiu, Ixyuzw->IJ', t1_aaca, v_caca_so, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('axJy, azwu, Ixwuyz->IJ', t1_eaca, v_eaaa_so, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('axyz, Jawu, Ixwuyz->IJ', t1_eaaa, v_ceaa_so, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('axyz, Jwau, Iyzuxw->IJ', t1_eaaa, v_caea_so, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xyJz, xwuv, Iyuvzw->IJ', t2_aaca, v_aaaa_so, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyJz, wuzv, Ixyvwu->IJ', t2_aaca, v_aaaa_so, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('J, xyJi, zwiu, Ixyuzw->IJ', e_core_so, t1_aacc, t1_aaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('J, axJy, azwu, Ixwuyz->IJ', e_core_so, t1_eaca, t1_eaaa, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('i, xyJi, zwiu, Ixyuzw->IJ', e_core_so, t1_aacc, t1_aaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.5 * np.einsum('a, axyz, awJu, Iyzwxu->IJ', e_extern_so, t1_eaaa, t1_eaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xy, xzJi, wuiv, Iyzvwu->IJ', h_aa_so, t1_aacc, t1_aaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xy, xziw, uvJi, Iwuvyz->IJ', h_aa_so, t1_aaca, t1_aacc, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xy, xaJz, awuv, Iyuvzw->IJ', h_aa_so, t1_aeca, t1_eaaa, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xy, xazw, auJv, Izwuyv->IJ', h_aa_so, t1_aeaa, t1_eaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xy, zwxi, uvJi, Iyuvzw->IJ', h_aa_so, t1_aaac, t1_aacc, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xy, azJx, awuv, Izuvyw->IJ', h_aa_so, t1_eaca, t1_eaaa, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xy, azxw, auJv, Iywuzv->IJ', h_aa_so, t1_eaaa, t1_eaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.0625 * np.einsum('xyzw, xyJi, uvis, Izwsuv->IJ', v_aaaa_so, t1_aacc, t1_aaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= np.einsum('xyzw, xuJi, zvis, Iwusyv->IJ', v_aaaa_so, t1_aacc, t1_aaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzw, xuJi, uvis, Izwsyv->IJ', v_aaaa_so, t1_aacc, t1_aaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, xuJi, iv, Izwuyv->IJ', v_aaaa_so, t1_aacc, t1_ca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('xyzw, xuJi, vsyi, Izwuvs->IJ', v_aaaa_so, t1_aacc, t1_aaac, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, xa, auJv, Izwuyv->IJ', v_aaaa_so, t1_ae, t1_eaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('xyzw, xaJu, zavs, Iwvsyu->IJ', v_aaaa_so, t1_aeca, t1_aeaa, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzw, xaJu, av, Izwvyu->IJ', v_aaaa_so, t1_aeca, t1_ea, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, xaJu, avys, Izwsuv->IJ', v_aaaa_so, t1_aeca, t1_eaaa, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzw, xaJi, auiv, Izwvyu->IJ', v_aaaa_so, t1_aecc, t1_eaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.0625 * np.einsum('xyzw, zwiu, vsJi, Iuvsxy->IJ', v_aaaa_so, t1_aaca, t1_aacc, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, zuiv, usJi, Iwvsxy->IJ', v_aaaa_so, t1_aaca, t1_aacc, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyzw, zi, uvJi, Iwuvxy->IJ', v_aaaa_so, t1_ac, t1_aacc, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyzw, zauv, Ja, Iwuvxy->IJ', v_aaaa_so, t1_aeaa, t1_ce, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('xyzw, zauv, asJw, Iuvsxy->IJ', v_aaaa_so, t1_aeaa, t1_eaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, zaiu, avJi, Iwuvxy->IJ', v_aaaa_so, t1_aeca, t1_eacc, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzw, uvxi, usJi, Izwsyv->IJ', v_aaaa_so, t1_aaac, t1_aacc, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyzw, auJz, auvs, Iwvsxy->IJ', v_aaaa_so, t1_eaca, t1_eaaa, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzw, auJz, av, Iwuvxy->IJ', v_aaaa_so, t1_eaca, t1_ea, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyzw, auxy, avJs, Izwvus->IJ', v_aaaa_so, t1_eaaa, t1_eaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, auxv, Ja, Izwvyu->IJ', v_aaaa_so, t1_eaaa, t1_ce, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, auxv, auJs, Izwvys->IJ', v_aaaa_so, t1_eaaa, t1_eaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('xyzw, auxi, avJi, Izwvyu->IJ', v_aaaa_so, t1_eaac, t1_eacc, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.0625 * np.einsum('xyzw, abJz, abuv, Iwuvxy->IJ', v_aaaa_so, t1_eeca, t1_eeaa, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyzw, abxu, abJv, Izwuyv->IJ', v_aaaa_so, t1_eeaa, t1_eeca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('ixiy, xzJj, wujv, Iyzvwu->IJ', v_caca_so, t1_aacc, t1_aaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('ixiy, xaJz, awuv, Iyuvzw->IJ', v_caca_so, t1_aeca, t1_eaaa, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('ixiy, yzjw, uvJj, Iwuvxz->IJ', v_caca_so, t1_aaca, t1_aacc, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('ixiy, yazw, auJv, Izwuxv->IJ', v_caca_so, t1_aeaa, t1_eaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('ixiy, zwxj, uvJj, Iyuvzw->IJ', v_caca_so, t1_aaac, t1_aacc, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.25 * np.einsum('ixiy, azJy, awuv, Izuvxw->IJ', v_caca_so, t1_eaca, t1_eaaa, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.5 * np.einsum('ixiy, azxw, auJv, Iywuzv->IJ', v_caca_so, t1_eaaa, t1_eaca, trdm_cccaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyzw, xuJi, vsit, Izwutyvs->IJ', v_aaaa_so, t1_aacc, t1_aaca, trdm_ccccaaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('xyzw, xaJu, avst, Izwstyuv->IJ', v_aaaa_so, t1_aeca, t1_eaaa, trdm_ccccaaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyzw, zuiv, stJi, Iwvstxyu->IJ', v_aaaa_so, t1_aaca, t1_aacc, trdm_ccccaaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.125 * np.einsum('xyzw, zauv, asJt, Iwuvsxyt->IJ', v_aaaa_so, t1_aeaa, t1_eaca, trdm_ccccaaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.0625 * np.einsum('xyzw, uvxi, stJi, Izwstyuv->IJ', v_aaaa_so, t1_aaac, t1_aacc, trdm_ccccaaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] -= 0.125 * np.einsum('xyzw, auJz, avst, Iwustxyv->IJ', v_aaaa_so, t1_eaca, t1_eaaa, trdm_ccccaaa_so, optimize = True).reshape(ni_cas, ni_so).copy()
        M[sI:fI, si:fi] += 0.25 * np.einsum('xyzw, auxv, asJt, Izwvsyut->IJ', v_aaaa_so, t1_eaaa, t1_eaca, trdm_ccccaaa_so, optimize = True).reshape(ni_cas, ni_so).copy()

    M[si:fi, sI:fI] = M[sI:fI, si:fi].T.copy()

    # i - j
    if ncore_so > 0:
        print "Computing M(i - j)..."
        sys.stdout.flush()

        M[si:fi, si:fi] = 0.5 * np.einsum('Ix, Jx->IJ', h_ca_so, t1_ca,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ia, Ja->IJ', h_ce_so, t1_ce,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Jx, Ix->IJ', h_ca_so, t1_ca,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ja, Ia->IJ', h_ce_so, t1_ce,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ix, Jixi->IJ', t1_ca, v_ccac_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ia, Jiai->IJ', t1_ce, v_ccec_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Jx, xiIi->IJ', t1_ca, v_accc_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ja, aiIi->IJ', t1_ce, v_eccc_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyIi, Jixy->IJ', t1_aacc, v_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyJi, xyIi->IJ', t1_aacc, v_aacc_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xi, JxIi->IJ', t1_ac, v_cacc_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xaIi, Jixa->IJ', t1_aecc, v_ccae_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xaJi, xaIi->IJ', t1_aecc, v_aecc_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ix, JiIx->IJ', t1_ca, v_ccca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ia, JiIa->IJ', t1_ce, v_ccce_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ai, JaIi->IJ', t1_ec, v_cecc_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('abIi, Jiab->IJ', t1_eecc, v_ccee_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('abJi, abIi->IJ', t1_eecc, v_eecc_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('I, Ix, Jx->IJ', e_core_so, t1_ca, t1_ca,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('I, Ia, Ja->IJ', e_core_so, t1_ce, t1_ce,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('I, xyIi, xyJi->IJ', e_core_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('I, axIi, axJi->IJ', e_core_so, t1_eacc, t1_eacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('I, abIi, abJi->IJ', e_core_so, t1_eecc, t1_eecc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('J, Ix, Jx->IJ', e_core_so, t1_ca, t1_ca,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('J, Ia, Ja->IJ', e_core_so, t1_ce, t1_ce,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('J, xyIi, xyJi->IJ', e_core_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('J, axIi, axJi->IJ', e_core_so, t1_eacc, t1_eacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('J, abIi, abJi->IJ', e_core_so, t1_eecc, t1_eecc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('i, xyIi, xyJi->IJ', e_core_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('i, xyJi, xyIi->IJ', e_core_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('i, axIi, axJi->IJ', e_core_so, t1_eacc, t1_eacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('i, axJi, axIi->IJ', e_core_so, t1_eacc, t1_eacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('i, abIi, abJi->IJ', e_core_so, t1_eecc, t1_eecc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('i, abJi, abIi->IJ', e_core_so, t1_eecc, t1_eecc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('a, Ia, Ja->IJ', e_extern_so, t1_ce, t1_ce,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('a, axIi, axJi->IJ', e_extern_so, t1_eacc, t1_eacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('a, abIi, abJi->IJ', e_extern_so, t1_eecc, t1_eecc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xy, Ix, Jy->IJ', h_aa_so, t1_ca, t1_ca,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xy, xzIi, yzJi->IJ', h_aa_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xy, xaIi, yaJi->IJ', h_aa_so, t1_aecc, t1_aecc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyzw, xyJi, zwIi->IJ', v_aaaa_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('ixiy, Jx, Iy->IJ', v_caca_so, t1_ca, t1_ca,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('ixiy, xzJj, yzIj->IJ', v_caca_so, t1_aacc, t1_aacc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('ixiy, xaJj, yaIj->IJ', v_caca_so, t1_aecc, t1_aecc,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ix, xyJz, yz->IJ', h_ca_so, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ia, axJy, xy->IJ', h_ce_so, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Jx, xyIz, zy->IJ', h_ca_so, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ja, axIy, yx->IJ', h_ce_so, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ix, Jyxz, zy->IJ', t1_ca, v_caaa_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ia, Jxay, yx->IJ', t1_ce, v_caea_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Jx, xyIz, zy->IJ', t1_ca, v_aaca_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('Ja, axIy, yx->IJ', t1_ce, v_eaca_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyIz, Jwxy, zw->IJ', t1_aaca, v_caaa_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xyIz, Jixi, zy->IJ', t1_aaca, v_ccac_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xyIi, Jixz, zy->IJ', t1_aacc, v_ccaa_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyJz, xyIw, wz->IJ', t1_aaca, v_aaca_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xyJz, xiIi, yz->IJ', t1_aaca, v_accc_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xyJi, xzIi, yz->IJ', t1_aacc, v_aacc_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xyiz, JxIi, yz->IJ', t1_aaca, v_cacc_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xyiz, JiIx, zy->IJ', t1_aaca, v_ccca_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xaIy, Jzxa, yz->IJ', t1_aeca, v_caae_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xaJy, xaIz, zy->IJ', t1_aeca, v_aeca_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ix, JiIy, yx->IJ', t1_ca, v_ccca_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ix, JyIi, xy->IJ', t1_ca, v_cacc_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ax, JaIy, yx->IJ', t1_ea, v_ceca_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ax, JyIa, xy->IJ', t1_ea, v_cace_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('axIy, Jiai, yx->IJ', t1_eaca, v_ccec_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('axIi, Jiay, yx->IJ', t1_eacc, v_ccea_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('axJy, aiIi, xy->IJ', t1_eaca, v_eccc_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('axJi, ayIi, xy->IJ', t1_eacc, v_eacc_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('axiy, JaIi, xy->IJ', t1_eaca, v_cecc_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('axiy, JiIa, yx->IJ', t1_eaca, v_ccce_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('abIx, Jyab, xy->IJ', t1_eeca, v_caee_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('abJx, abIy, yx->IJ', t1_eeca, v_eeca_so, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('I, Ix, xyJz, yz->IJ', e_core_so, t1_ca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('I, Ia, axJy, xy->IJ', e_core_so, t1_ce, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('I, Jx, xyIz, zy->IJ', e_core_so, t1_ca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('I, Ja, axIy, yx->IJ', e_core_so, t1_ce, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('I, xyIz, xyJw, zw->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('I, xyIi, xzJi, zy->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('I, axIy, axJz, yz->IJ', e_core_so, t1_eaca, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('I, axIi, ayJi, yx->IJ', e_core_so, t1_eacc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('I, abIx, abJy, xy->IJ', e_core_so, t1_eeca, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('J, Ix, xyJz, yz->IJ', e_core_so, t1_ca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('J, Ia, axJy, xy->IJ', e_core_so, t1_ce, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('J, Jx, xyIz, zy->IJ', e_core_so, t1_ca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('J, Ja, axIy, yx->IJ', e_core_so, t1_ce, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('J, xyIz, xyJw, zw->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('J, xyIi, xzJi, zy->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('J, axIy, axJz, yz->IJ', e_core_so, t1_eaca, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('J, axIi, ayJi, yx->IJ', e_core_so, t1_eacc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('J, abIx, abJy, xy->IJ', e_core_so, t1_eeca, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('i, xyIi, xzJi, zy->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('i, xyJi, xzIi, yz->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('i, axIi, ayJi, yx->IJ', e_core_so, t1_eacc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('i, axJi, ayIi, xy->IJ', e_core_so, t1_eacc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('a, Ia, axJy, xy->IJ', e_extern_so, t1_ce, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('a, axIy, Ja, yx->IJ', e_extern_so, t1_eaca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('a, axIy, axJz, yz->IJ', e_extern_so, t1_eaca, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('a, axIi, ayJi, yx->IJ', e_extern_so, t1_eacc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('a, abIx, abJy, xy->IJ', e_extern_so, t1_eeca, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xy, Ix, yzJw, zw->IJ', h_aa_so, t1_ca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xy, Jx, yzIw, wz->IJ', h_aa_so, t1_ca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xy, xzIw, Jz, wy->IJ', h_aa_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xy, xzIw, yzJu, wu->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('xy, xzIi, ywJi, wz->IJ', h_aa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, xzIi, zwJi, wy->IJ', h_aa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xy, xzJw, Iz, yw->IJ', h_aa_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, xzJi, zwIi, yw->IJ', h_aa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xy, xaIz, Ja, zy->IJ', h_aa_so, t1_aeca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xy, xaIz, yaJw, zw->IJ', h_aa_so, t1_aeca, t1_aeca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, xaIi, azJi, zy->IJ', h_aa_so, t1_aecc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xy, xaJz, Ia, yz->IJ', h_aa_so, t1_aeca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, xaJi, azIi, yz->IJ', h_aa_so, t1_aecc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xy, zwIx, Jz, yw->IJ', h_aa_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xy, zwIx, zwJu, yu->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xy, zwJx, Iz, wy->IJ', h_aa_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xy, zwJx, zwIu, uy->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xy, azIx, Ja, yz->IJ', h_aa_so, t1_eaca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xy, azIx, azJw, yw->IJ', h_aa_so, t1_eaca, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xy, azJx, Ia, zy->IJ', h_aa_so, t1_eaca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xy, azJx, azIw, wy->IJ', h_aa_so, t1_eaca, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xy, abIx, abJz, yz->IJ', h_aa_so, t1_eeca, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xy, abJx, abIz, zy->IJ', h_aa_so, t1_eeca, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xyzw, Jx, Iz, wy->IJ', v_aaaa_so, t1_ca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xyzw, Jx, zwIu, uy->IJ', v_aaaa_so, t1_ca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xyzw, xyJu, Iz, wu->IJ', v_aaaa_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyzw, xyJu, zwIv, vu->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xyzw, xyJi, zuIi, wu->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xyzw, xuJi, zwIi, uy->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xyzw, xuJi, zuIi, wy->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xyzw, xaJi, zaIi, wy->IJ', v_aaaa_so, t1_aecc, t1_aecc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('ixiy, Jx, yzIw, wz->IJ', v_caca_so, t1_ca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('ixiy, xzJw, Iy, zw->IJ', v_caca_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ixiy, xzJw, Iz, yw->IJ', v_caca_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('ixiy, xzJw, yzIu, uw->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('ixiy, xzJj, ywIj, zw->IJ', v_caca_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, xzJj, zwIj, yw->IJ', v_caca_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ixiy, xaJz, Ia, yz->IJ', v_caca_so, t1_aeca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('ixiy, xaJz, yaIw, wz->IJ', v_caca_so, t1_aeca, t1_aeca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, xaJj, azIj, yz->IJ', v_caca_so, t1_aecc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ixiy, yzIw, Jz, wx->IJ', v_caca_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, yzIj, zwJj, wx->IJ', v_caca_so, t1_aacc, t1_aacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ixiy, yaIz, Ja, zx->IJ', v_caca_so, t1_aeca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, yaIj, azJj, zx->IJ', v_caca_so, t1_aecc, t1_eacc, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ixiy, zwIx, Jz, yw->IJ', v_caca_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('ixiy, zwIx, zwJu, yu->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ixiy, zwJy, Iz, wx->IJ', v_caca_so, t1_aaca, t1_ca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('ixiy, zwJy, zwIu, ux->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ixiy, azIx, Ja, yz->IJ', v_caca_so, t1_eaca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ixiy, azIx, azJw, yw->IJ', v_caca_so, t1_eaca, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ixiy, azJy, Ia, zx->IJ', v_caca_so, t1_eaca, t1_ce, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('ixiy, azJy, azIw, wx->IJ', v_caca_so, t1_eaca, t1_eaca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('ixiy, abIx, abJz, yz->IJ', v_caca_so, t1_eeca, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('ixiy, abJy, abIz, zx->IJ', v_caca_so, t1_eeca, t1_eeca, rdm_ca_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.125 * np.einsum('xyIz, Jzwu, wuxy->IJ', t1_aaca, v_caaa_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xyIz, Jwxu, zuyw->IJ', t1_aaca, v_caaa_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.125 * np.einsum('xyIi, Jizw, zwxy->IJ', t1_aacc, v_ccaa_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xyJz, xwIu, yuzw->IJ', t1_aaca, v_aaca_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.125 * np.einsum('xyJz, wuIz, xywu->IJ', t1_aaca, v_aaca_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.125 * np.einsum('xyJi, zwIi, xyzw->IJ', t1_aacc, v_aacc_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyiz, JiIw, zwxy->IJ', t1_aaca, v_ccca_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyiz, JwIi, xyzw->IJ', t1_aaca, v_cacc_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('axIy, Jzaw, ywxz->IJ', t1_eaca, v_caea_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('axJy, azIw, xwyz->IJ', t1_eaca, v_eaca_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('axyz, JaIw, xwyz->IJ', t1_eaaa, v_ceca_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('axyz, JwIa, yzxw->IJ', t1_eaaa, v_cace_so, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('I, xyIz, xwJu, zwyu->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.125 * np.einsum('I, xyIz, wuJz, wuxy->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.125 * np.einsum('I, xyIi, zwJi, zwxy->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('I, axIy, azJw, yzxw->IJ', e_core_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('J, xyIz, xwJu, zwyu->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.125 * np.einsum('J, xyIz, wuJz, wuxy->IJ', e_core_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.125 * np.einsum('J, xyIi, zwJi, zwxy->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('J, axIy, azJw, yzxw->IJ', e_core_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('i, xyJi, zwIi, xyzw->IJ', e_core_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('a, axIy, azJw, yzxw->IJ', e_extern_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('xy, xzIw, yuJv, wuzv->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, xzIw, zuJv, wuyv->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xy, xzIw, uvJw, uvyz->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xy, xzIi, wuJi, wuyz->IJ', h_aa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, xzJw, zuIv, yvwu->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xy, xzJw, uvIw, yzuv->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xy, xzJi, wuIi, yzwu->IJ', h_aa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, xaIz, awJu, zwyu->IJ', h_aa_so, t1_aeca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, xaJz, awIu, yuzw->IJ', h_aa_so, t1_aeca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, zwIx, zuJv, yuwv->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xy, zwIx, uvJy, uvzw->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, zwJx, zuIv, wvyu->IJ', h_aa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, azIx, awJu, ywzu->IJ', h_aa_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xy, azJx, awIu, zuyw->IJ', h_aa_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, Iz, uvJw, uvxy->IJ', v_aaaa_so, t1_ca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('xyzw, Jx, zuIv, wvyu->IJ', v_aaaa_so, t1_ca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, Jx, uvIy, zwuv->IJ', v_aaaa_so, t1_ca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.5 * np.einsum('xyzw, xyJu, zvIs, wsuv->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.0625 * np.einsum('xyzw, xyJu, vsIu, zwvs->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.0625 * np.einsum('xyzw, xyJi, uvIi, zwuv->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('xyzw, xuJv, Iz, wuyv->IJ', v_aaaa_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, xuJv, Iu, zwyv->IJ', v_aaaa_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('xyzw, xuJv, zwIs, usyv->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('xyzw, xuJv, zuIs, wsyv->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, xuJv, usIy, zwvs->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += np.einsum('xyzw, xuJi, zvIi, wuyv->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyzw, xuJi, uvIi, zwyv->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, xaJu, Ia, zwyu->IJ', v_aaaa_so, t1_aeca, t1_ce, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('xyzw, xaJu, zaIv, wvyu->IJ', v_aaaa_so, t1_aeca, t1_aeca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, xaJu, avIy, zwuv->IJ', v_aaaa_so, t1_aeca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyzw, xaJi, auIi, zwyu->IJ', v_aaaa_so, t1_aecc, t1_eacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.0625 * np.einsum('xyzw, zwIu, vsJu, vsxy->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.0625 * np.einsum('xyzw, zwIi, uvJi, uvxy->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, zuIv, Ju, wvxy->IJ', v_aaaa_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, zuIv, usJw, vsxy->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyzw, zuIi, uvJi, wvxy->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, zaIu, Ja, wuxy->IJ', v_aaaa_so, t1_aeca, t1_ce, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, zaIu, avJw, uvxy->IJ', v_aaaa_so, t1_aeca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyzw, zaIi, auJi, wuxy->IJ', v_aaaa_so, t1_aecc, t1_eacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, uvIx, Ju, zwyv->IJ', v_aaaa_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.125 * np.einsum('xyzw, uvIx, uvJs, zwys->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, uvJz, Iu, wvxy->IJ', v_aaaa_so, t1_aaca, t1_ca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.125 * np.einsum('xyzw, uvJz, uvIs, wsxy->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, auIx, Ja, zwyu->IJ', v_aaaa_so, t1_eaca, t1_ce, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, auIx, auJv, zwyv->IJ', v_aaaa_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, auJz, Ia, wuxy->IJ', v_aaaa_so, t1_eaca, t1_ce, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, auJz, auIv, wvxy->IJ', v_aaaa_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.125 * np.einsum('xyzw, abIx, abJu, zwyu->IJ', v_aaaa_so, t1_eeca, t1_eeca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.125 * np.einsum('xyzw, abJz, abIu, wuxy->IJ', v_aaaa_so, t1_eeca, t1_eeca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('ixiy, xzJw, yuIv, zvwu->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, xzJw, zuIv, yvwu->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('ixiy, xzJw, uvIw, yzuv->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('ixiy, xzJj, wuIj, yzwu->IJ', v_caca_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, xaJz, awIu, yuzw->IJ', v_caca_so, t1_aeca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, yzIw, zuJv, wuxv->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('ixiy, yzIw, uvJw, uvxz->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('ixiy, yzIj, wuJj, wuxz->IJ', v_caca_so, t1_aacc, t1_aacc, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, yaIz, awJu, zwxu->IJ', v_caca_so, t1_aeca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, zwIx, zuJv, yuwv->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('ixiy, zwIx, uvJy, uvzw->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, zwJy, zuIv, wvxu->IJ', v_caca_so, t1_aaca, t1_aaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, azIx, awJu, ywzu->IJ', v_caca_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.5 * np.einsum('ixiy, azJy, awIu, zuxw->IJ', v_caca_so, t1_eaca, t1_eaca, rdm_ccaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= np.einsum('xyzw, xuJv, zsIt, wutyvs->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, xuJv, usIt, zwtyvs->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, xuJv, stIy, zwuvst->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.125 * np.einsum('xyzw, xuJv, stIv, zwuyst->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.125 * np.einsum('xyzw, xuJi, vsIi, zwuyvs->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, xaJu, avIs, zwsyuv->IJ', v_aaaa_so, t1_aeca, t1_eaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, zuIv, usJt, wvsxyt->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, zuIv, stJw, vstxyu->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.125 * np.einsum('xyzw, zuIv, stJv, wstxyu->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.125 * np.einsum('xyzw, zuIi, vsJi, wvsxyu->IJ', v_aaaa_so, t1_aacc, t1_aacc, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, zaIu, avJs, wuvxys->IJ', v_aaaa_so, t1_aeca, t1_eaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, uvIx, usJt, zwsyvt->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] += 0.25 * np.einsum('xyzw, uvIx, stJz, wstyuv->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, uvJz, usIt, wvtxys->IJ', v_aaaa_so, t1_aaca, t1_aaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, auIx, avJs, zwvyus->IJ', v_aaaa_so, t1_eaca, t1_eaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()
        M[si:fi, si:fi] -= 0.25 * np.einsum('xyzw, auJz, avIs, wusxyv->IJ', v_aaaa_so, t1_eaca, t1_eaca, rdm_cccaaa_so,optimize = True).reshape(ni_so, ni_so).copy()

#    M[si:fi, si:fi] = M[si:fi, si:fi].T.copy()

#    print np.linalg.norm(M - M.T)

    return M

